# 飞书小说下载系统 - 文件说明

## 核心文件

### 🐍 Python 模块
- **`cron_deployment.py`** - 主执行脚本，支持多种命令
  - `fetch` - 从飞书拉取数据到 first_table
  - `sync` - 数据同步 (first_table → second_table)
  - `download` - 文件下载
  - `daily` - 完整流程 (fetch + sync + download)
  - `clean` - 清理测试数据

- **`database.py`** - 数据库操作模块
  - 表结构管理
  - 数据同步逻辑
  - CRUD 操作

- **`feishu_api.py`** - 飞书API模块
  - 访问令牌获取
  - 多维表格数据拉取
  - 文件下载功能

- **`config.py`** - 配置管理模块
  - 环境变量加载
  - 数据库配置
  - 飞书API配置

### 📋 配置文件
- **`requirements.txt`** - Python依赖包列表
- **`env_example.txt`** - 环境变量配置示例
- **`.env`** - 实际环境变量配置（部署时生成）

### 🚀 部署文件
- **`install_cron.sh`** - 一键部署脚本
- **`DEPLOY_GUIDE.md`** - 详细部署指南
- **`run_daily.sh`** - Cron定时任务脚本（部署时生成）

## 数据流程

```
飞书多维表格 → first_table → second_table → 文件下载
     ↑              ↑             ↑           ↑
   fetch命令      sync命令     download命令   daily命令
```

## 目录结构

```
/opt/feishu/                    # 项目目录
├── cron_deployment.py          # 主脚本
├── database.py                 # 数据库模块
├── feishu_api.py              # 飞书API模块
├── config.py                   # 配置模块
├── requirements.txt            # 依赖列表
├── .env                        # 环境配置
├── venv/                       # Python虚拟环境
└── run_daily.sh               # 定时任务脚本

/home/feishu/                   # 文件存储目录
├── 项目名1_时间戳/
│   ├── 字幕文件.txt
│   └── 描述词文件.txt
└── 项目名2_时间戳/
    ├── 字幕文件.txt
    └── 描述词文件.txt

/var/log/feishu/               # 日志目录
├── feishu_20250707.log        # 按日期分割的日志
└── cron.log                   # Cron任务日志
```

## 📁 部署文件清单

### 🔧 核心执行文件
- **`cron_deployment.py`** - 主要执行脚本（支持 sync/download/daily 命令）
- **`config.py`** - 配置管理模块
- **`database.py`** - 数据库操作模块
- **`feishu_api.py`** - 飞书API接口模块

### 📦 部署工具
- **`install_cron.sh`** - 一键安装脚本
- **`requirements.txt`** - Python依赖包列表

### 📋 配置文件
- **`env_example.txt`** - 环境配置示例（需复制为 .env 并修改）

### 📖 文档
- **`DEPLOY_GUIDE.md`** - 完整部署指南
- **`文件说明.md`** - 本文件

## 🚀 快速部署

1. **上传所有文件到服务器临时目录**
2. **执行安装脚本**：`chmod +x install_cron.sh && ./install_cron.sh`
3. **配置数据库信息**：编辑 `/opt/xiaoshuo/.env`
4. **验证定时任务**：`crontab -l`

## 🎯 功能说明

- **每天早上8点自动执行**数据同步和文件下载
- **文件保存位置**：`/home/xiaoshuo/项目名_时间戳/`
- **日志文件位置**：`/var/log/xiaoshuo/cron.log`
- **配置文件位置**：`/opt/xiaoshuo/.env`

## 📞 常用命令

```bash
# 手动执行完整任务
cd /opt/xiaoshuo && source venv/bin/activate && python3 cron_deployment.py daily

# 查看日志
tail -f /var/log/xiaoshuo/cron.log

# 查看下载文件
ls -la /home/xiaoshuo/

# 查看定时任务
crontab -l
``` 